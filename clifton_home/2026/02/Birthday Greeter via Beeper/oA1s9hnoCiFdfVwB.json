{"updatedAt":"2026-02-16T00:06:49.003Z","createdAt":"2026-02-06T14:16:30.280Z","id":"oA1s9hnoCiFdfVwB","name":"Birthday Greeter via Beeper","description":null,"active":true,"isArchived":false,"nodes":[{"parameters":{},"id":"a185a801-00cb-4ad3-a319-b4b18ec1c311","name":"Manual Trigger","type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[8016,-48],"notes":"Click to test the full flow. Bypasses the Random Delay and uses the hardcoded phone number in Filter Todays Birthdays instead of reading from the Excel sheet."},{"parameters":{"amount":"={{ Math.floor(Math.random() * 27) + 1 }}","unit":"minutes"},"id":"7f633ec5-f24c-45d0-836a-a0b01291d89d","name":"Random Delay","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[8016,-240],"webhookId":"95f3e208-a850-470d-a07e-2f9f7d484a95","notes":"Waits a random 1-27 minutes so messages don't always arrive at exactly 6 AM."},{"parameters":{"jsCode":"return [\n  { json: { ip: '192.168.2.2' } },\n  { json: { ip: '192.168.10.181' } },\n  { json: { ip: '192.168.10.225' } }\n];"},"id":"7ba6c5e9-551c-439a-879f-f57a4c349d9a","name":"Generate IP Candidates","type":"n8n-nodes-base.code","typeVersion":2,"position":[8272,-240],"notes":"Add/remove IPs here if your laptop's addresses change."},{"parameters":{"url":"=http://{{ $json.ip }}:23373/v1/chats?limit=1","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{"timeout":5000}},"id":"8eadaae3-b890-4dd1-b8be-5b71e06a1789","name":"Beeper Health Check","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[8528,-240],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"continueOnFail":true,"notes":"Pings each IP on port 23373. continueOnFail lets failed IPs pass through so the next node can pick the live one. Requires Beeper Desktop to be running with Remote Access enabled and the BEEPER_API_KEY environment variable set in n8n."},{"parameters":{"jsCode":"const checks = $input.all();\nconst ips = $('Generate IP Candidates').all();\n\nfor (let i = 0; i < checks.length; i++) {\n  if (checks[i].json.items !== undefined) {\n    return [{ json: { beeperHost: 'http://' + ips[i].json.ip + ':23373' } }];\n  }\n}\n\nthrow new Error('Beeper Desktop not reachable on any configured IP. Ensure it is running with Remote Access enabled.');"},"id":"69176f82-3fc6-4ee5-95f3-5a7f4c3b550c","name":"Select Live Host","type":"n8n-nodes-base.code","typeVersion":2,"position":[8768,-240],"onError":"continueErrorOutput","notes":"Picks the first IP that returned a valid Beeper API response."},{"parameters":{"documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=0"},"options":{}},"id":"756d2aff-6c55-42f9-bd13-48e47f84c3fd","name":"Read Birthday Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[9024,-240],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Configure: 1) Set Google Sheets OAuth2 credential. 2) Paste your Google Sheet URL in the Document field.\\n\\nGoogle Sheet columns:\\n- Name: person's name (used in the birthday message)\\n- Birthday: supports MM-DD, MM/DD, YYYY-MM-DD, YYYY/MM/DD formats\\n- Phone: number without the + prefix (e.g. 14155552671). The workflow adds the + automatically since Google Sheets strips it\\n- Relay: boolean (TRUE/FALSE). If TRUE, sends 'Tell <Name> I said happy birthday!' to the Phone number instead of a direct greeting. Use this when the phone number belongs to someone else (e.g. sending to mom for the kid).\\n- Dinner: boolean (TRUE/FALSE). If TRUE, sends a follow-up message after 4-12 seconds asking about dinner plans."},{"parameters":{"jsCode":"const timeZone = 'America/New_York'; // Change to your timezone\nconst today = new Date().toLocaleDateString('en-US', { timeZone });\nconst [todayMonth, todayDay] = today.split('/').map(Number);\n\nreturn $input.all()\n  .filter(item => {\n    const phone = String(item.json.Phone || '').trim();\n    const bday = String(item.json.Birthday || '').trim();\n    if (!phone || !bday) return false;\n\n    // Strip invisible characters then split on / or -\n    const clean = bday.replace(/[^\\d\\/-]/g, '');\n    const parts = clean.split(/[\\/\\-]/);\n\n    let month, day;\n    if (parts.length === 3) {\n      if (parts[0].length === 4) {\n        // YYYY-MM-DD\n        month = parseInt(parts[1], 10);\n        day = parseInt(parts[2], 10);\n      } else {\n        // MM/DD/YYYY\n        month = parseInt(parts[0], 10);\n        day = parseInt(parts[1], 10);\n      }\n    } else if (parts.length === 2) {\n      // MM-DD or MM/DD\n      month = parseInt(parts[0], 10);\n      day = parseInt(parts[1], 10);\n    } else {\n      return false;\n    }\n\n    return month === todayMonth && day === todayDay;\n  })\n  .map(item => {\n    let phone = String(item.json.Phone).trim();\n    if (!phone.startsWith('+')) phone = '+' + phone;\n    return { json: { ...item.json, Phone: phone } };\n  });"},"id":"495225ca-c820-44b4-bc75-1aa1c61e18ff","name":"Filter Todays Birthdays","type":"n8n-nodes-base.code","typeVersion":2,"position":[9328,-240],"notes":"Supports MM-DD, MM/DD, YYYY-MM-DD, YYYY/MM/DD date formats. Skips rows with missing Phone or Birthday. Prepends '+' to phone numbers (Google Sheets strips the +)."},{"parameters":{"url":"={{ $('Select Live Host').first().json.beeperHost }}/v1/chats/search","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"query","value":"={{ $json.Phone }}"},{"name":"scope","value":"participants"},{"name":"type","value":"single"},{"name":"accountIDs","value":"imessage_c486047869de25aa846dda045493a09a"}]},"options":{}},"id":"81c930f0-d7de-4b23-a5fd-e63869ee2e83","name":"Search Chat by Phone","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[10288,-240],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Searches Beeper for a DM chat matching this phone number. Phone must be in E.164 format (+country code + number) to match correctly."},{"parameters":{"jsCode":"const searches = $input.all();\nconst people = $('Filter Todays Birthdays').all();\nconst host = $('Select Live Host').first().json.beeperHost;\n\nconst directTemplates = [\n  () => `Happy Birthday! \\ud83c\\udf82 Hope your day is as sweet as cake!`,\n  () => `Happy Birthday!!! \\ud83c\\udf89\\ud83c\\udf89\\ud83c\\udf89`,\n  () => `It's your birthday! \\ud83c\\udf88\\ud83c\\udf88 Sending you all the balloons!`,\n  () => `Happy Birthday! \\ud83c\\udf1f Hope it's a great one!`,\n  () => `Wishing you a wonderful birthday! \\ud83e\\udd73\\ud83c\\udf8a`,\n  () => `Happy Birthday! \\ud83c\\udf82\\ud83c\\udf88\\ud83c\\udf81 Party time!`,\n  () => `Happy birthday!! \\ud83e\\udd42 Cheers to another year!`\n];\n\nreturn searches.map((search, i) => {\n  const person = people[i].json;\n  const items = search.json.items || [];\n  const chatID = items.length > 0 ? items[0].id : null;\n  const relay = String(person.Relay || '').toLowerCase() === 'true' || person.Relay === true;\n  let message;\n  if (relay) {\n    message = `Tell ${person.Name.split(\" \")[0]} I said happy birthday!`;\n  } else {\n    const template = directTemplates[Math.floor(Math.random() * directTemplates.length)];\n    message = template();\n  }\n\n  const dinner = String(person.Dinner || '').toLowerCase() === 'true' || person.Dinner === true;\n\n  const dinnerTemplates = [\n    'Want to grab dinner sometime to celebrate?',\n    'Lets do a birthday dinner soon!',\n    'Let me know if you want to grab dinner sometime to celebrate!',\n    'Down for a birthday dinner sometime soon?'\n  ];\n  const dinnerMessage = dinnerTemplates[Math.floor(Math.random() * dinnerTemplates.length)];\n\n  return {\n    json: {\n      chatID: chatID ? encodeURIComponent(chatID) : null,\n      chatFound: chatID !== null,\n      name: person.Name,\n      phone: person.Phone,\n      beeperHost: host,\n      message: message,\n      dinner: dinner,\n      dinnerMessage: dinnerMessage\n    }\n  };\n});"},"id":"5d9cb2e7-5a3d-451d-8120-eb337d655f8d","name":"Extract Chat ID","type":"n8n-nodes-base.code","typeVersion":2,"position":[10528,-240],"notes":"Pairs search results with person data from the birthday filter. Picks a random greeting from 8 templates. If Relay is true, sends 'Tell <Name> I said happy birthday!' instead."},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"cond_chat_found","operator":{"type":"boolean","operation":"true","singleValue":true},"leftValue":"={{ $json.chatFound }}","rightValue":""}]},"options":{}},"id":"0f3d48e7-c55b-4998-92c2-109b8e303f22","name":"Chat Found?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[10784,-240],"notes":"TRUE: existing chat found, sends message directly. FALSE: no chat found, creates a new chat and sends the message via the Create Chat API."},{"parameters":{"method":"POST","url":"={{ $json.beeperHost }}/v1/chats/{{ $json.chatID }}/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\"text\": \"{{ $json.message }}\"}","options":{}},"id":"0413a79c-746a-4b09-9bb5-f0587551e624","name":"Send Birthday Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[11040,-240],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Sends the birthday greeting via Beeper Desktop API v1."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Date":"={{ new Date().toISOString() }}","Name":"={{ $('Chat Found?').item.json.name }}","Message":"={{ $('Chat Found?').item.json.message }}","Phone":"={{ $('Chat Found?').item.json.phone }}","Type":"birthday (existing chat)"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"ee78201b-62b9-4ab5-a45b-98023d6654c3","name":"Log Birthday Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[11280,-240],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the birthday message send to the 'Log' sheet tab. Configure: set the same Google Sheet URL and OAuth2 credential as 'Read Birthday Sheet'. Create a 'Log' sheet tab with columns: Date, Name, Phone, Type, Message."},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"cond_dinner","operator":{"type":"boolean","operation":"true","singleValue":true},"leftValue":"={{ $('Extract Chat ID').item.json.dinner }}","rightValue":""}]},"options":{}},"id":"f2b96a01-1c08-413b-9846-23e5d69fb311","name":"Dinner Plans?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[11536,-240],"notes":"Checks if the Dinner column is TRUE for this person."},{"parameters":{"amount":"={{ Math.floor(Math.random() * 9) + 4 }}"},"id":"dc9997bf-0476-4ba5-982f-2e5e926145c1","name":"Dinner Delay","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[11792,-240],"webhookId":"059e9f53-6fdb-4327-91ec-70c6a2397488","notes":"Waits a random 4-12 seconds before sending the dinner follow-up so it feels natural."},{"parameters":{"method":"POST","url":"={{ $('Extract Chat ID').item.json.beeperHost }}/v1/chats/{{ $('Extract Chat ID').item.json.chatID }}/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\"text\": \"{{ $('Extract Chat ID').item.json.dinnerMessage }}\"}","options":{}},"id":"09b698f5-3df3-4614-af3a-493fcfae6188","name":"Send Dinner Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[12032,-240],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Sends a follow-up message asking about dinner plans."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Message":"={{ $('Chat Found?').item.json.message }}","Name":"={{ $('Chat Found?').item.json.name }}","Phone":"={{ $('Chat Found?').item.json.phone }}","Type":"Birthday Dinner (existing chat)","Date":"={{ new Date().toISOString() }}"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"965186ab-0232-4c36-9980-d3ad192b3e77","name":"Log Dinner Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[12288,-240],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the dinner follow-up send to the 'Log' sheet tab."},{"parameters":{"jsCode":"const accountID = \"imessage_c486047869de25aa846dda045493a09a\";\n\nreturn $(\"Chat Found?\").all().map((data) => {\n  return {\n    json: {\n      accountID: accountID,\n      phone: data.json.phone,\n      beeperHost: data.json.beeperHost,\n      message: data.json.message,\n      name: data.json.name,\n      dinner: data.json.dinner,\n      dinnerMessage: data.json.dinnerMessage\n    }\n  };\n});"},"id":"e7e97c8f-b160-408a-b3d5-fc2645112920","name":"Prepare New Chat","type":"n8n-nodes-base.code","typeVersion":2,"position":[11040,32],"notes":"Picks the accountID for chat creation. Change preferredNetwork to match your primary messaging service (iMessage, WhatsApp, etc.)."},{"parameters":{"method":"POST","url":"={{ $json.beeperHost }}/v1/chats","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $env.BEEPER_API_KEY }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"accountID\": \"{{ $json.accountID }}\", \"participantIDs\": [\"{{ $json.phone }}\"], \"type\": \"single\", \"messageText\": \"{{ $json.message }}\"}","options":{}},"id":"097df7c5-1679-44fc-9c47-bf52e0c22ffc","name":"Create Chat & Send","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[11280,32],"notes":"Creates a new Beeper chat with the phone number and sends the birthday message as the first message via the messageText field."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Date":"={{ new Date().toISOString() }}","Name":"={{ $('Prepare New Chat').item.json.name }}","Phone":"={{ $('Prepare New Chat').item.json.phone }}","Type":"birthday (new chat)","Message":"={{ $('Prepare New Chat').item.json.message }}"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}]},"options":{}},"id":"d17f6d0f-674f-46b2-ab1a-df1078531202","name":"Log New Chat Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[11536,32],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the new chat birthday send to the 'Log' sheet tab."},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"cond_new_dinner","operator":{"type":"boolean","operation":"true","singleValue":true},"leftValue":"={{ $('Prepare New Chat').item.json.dinner }}","rightValue":""}]},"options":{}},"id":"104bbcd7-6f46-4dc9-9d83-61a1e00b15ae","name":"New Chat Dinner?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[11792,32],"notes":"Checks dinner flag for newly created chats."},{"parameters":{"amount":"={{ Math.floor(Math.random() * 9) + 4 }}"},"id":"dddd991e-cd35-4298-9f2d-90d38c3127a3","name":"New Chat Dinner Delay","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[12032,32],"webhookId":"fa57ba51-cf58-4468-9514-fab7f3c1992f","notes":"Random 4-12 second delay before dinner follow-up on new chat."},{"parameters":{"method":"POST","url":"={{ $('Prepare New Chat').item.json.beeperHost }}/v1/chats/{{ encodeURIComponent($('Create Chat & Send').item.json.chatID) }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $env.BEEPER_API_KEY }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"text\": \"{{ $('Prepare New Chat').item.json.dinnerMessage }}\"}","options":{}},"id":"97bfc563-7ad7-4c04-8daa-a916567ef090","name":"Send New Chat Dinner","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[12288,32],"notes":"Sends dinner follow-up to the newly created chat."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Date":"={{ new Date().toISOString() }}","Name":"={{ $('Prepare New Chat').item.json.name }}","Phone":"={{ $('Prepare New Chat').item.json.phone }}","Type":"dinner (new chat)","Message":"={{ $('Prepare New Chat').item.json.dinnerMessage }}"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}]},"options":{}},"id":"d3df4d9b-d962-476f-85b7-1e5d1906720b","name":"Log New Chat Dinner Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[12528,32],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the new chat dinner follow-up send to the 'Log' sheet tab."},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"0 6-22 * * *"}]}},"id":"179f6e2c-27a6-446a-a9ca-db1c1a080f03","name":"Daily 6AM Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[7776,-240],"notes":"Runs daily at 6 AM. Adjust triggerAtHour for your timezone."},{"parameters":{"jsCode":"const timeZone = 'America/New_York';\nconst today = new Date().toLocaleDateString('en-US', { timeZone });\nconst [todayMonth, todayDay] = today.split('/').map(Number);\n\nconst missedDates = [];\nfor (let i = 1; i <= 7; i++) {\n  const d = new Date();\n  d.setDate(d.getDate() - i);\n  const ds = d.toLocaleDateString('en-US', { timeZone });\n  const [m, day] = ds.split('/').map(Number);\n  missedDates.push({ month: m, day: day, daysLate: i });\n}\n\nreturn $input.all()\n  .map(item => {\n    const phone = String(item.json.Phone || '').trim();\n    const bday = String(item.json.Birthday || '').trim();\n    if (!phone || !bday) return null;\n\n    const clean = bday.replace(/[^\\d\\/-]/g, '');\n    const parts = clean.split(/[\\/\\-]/);\n\n    let month, day;\n    if (parts.length === 3) {\n      if (parts[0].length === 4) {\n        month = parseInt(parts[1], 10);\n        day = parseInt(parts[2], 10);\n      } else {\n        month = parseInt(parts[0], 10);\n        day = parseInt(parts[1], 10);\n      }\n    } else if (parts.length === 2) {\n      month = parseInt(parts[0], 10);\n      day = parseInt(parts[1], 10);\n    } else {\n      return null;\n    }\n\n    const match = missedDates.find(d => d.month === month && d.day === day);\n    if (!match) return null;\n\n    let phoneClean = phone;\n    if (!phoneClean.startsWith('+')) phoneClean = '+' + phoneClean;\n\n    return { json: { ...item.json, Phone: phoneClean, daysLate: match.daysLate } };\n  })\n  .filter(item => item !== null);"},"id":"676bf6b3-549d-4f60-adac-761a8c8dc8d9","name":"Filter Missed Birthdays","type":"n8n-nodes-base.code","typeVersion":2,"position":[9328,-480],"notes":"Checks last 7 days for birthdays that may have been missed. Same date parsing as Filter Todays Birthdays. Outputs matching rows with daysLate field."},{"parameters":{"documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"options":{}},"id":"984a10c6-a62c-4db4-a332-9710b1bd618f","name":"Read Sent Log","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[9584,-480],"executeOnce":true,"alwaysOutputData":true,"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Reads all entries from the Sent-log sheet to check which birthdays were already sent."},{"parameters":{"jsCode":"const missedBirthdays = $('Filter Missed Birthdays').all();\nconst logEntries = $input.all();\nconst fourteenDaysAgo = new Date(Date.now() - 8 * 24 * 60 * 60 * 1000);\n\n// Filter log to last 8 days only\nconst recentLogs = logEntries.filter(log => {\n  const logDate = new Date(log.json.Date);\n  return !isNaN(logDate) && logDate >= fourteenDaysAgo;\n});\n\nconst unsent = missedBirthdays.filter(mb => {\n  const phone = String(mb.json.Phone || '').trim().replace(/^\\+/, '');\n  return !recentLogs.some(log => {\n    const logPhone = String(log.json.Phone || '').trim().replace(/^\\+/, '');\n    const logType = String(log.json.Type || '').toLowerCase();\n    return logPhone === phone && logType.includes('birthday');\n  });\n});\n\nreturn unsent.map(mb => ({ json: { ...mb.json } }));"},"id":"bd2adada-0768-4dea-95bd-37fbd503adee","name":"Find Unsent Birthdays","type":"n8n-nodes-base.code","typeVersion":2,"position":[9840,-480],"notes":"Cross-references missed birthdays with the Sent-log. Filters out anyone who already received a birthday message in the last 8 days."},{"parameters":{"url":"={{ $('Select Live Host').first().json.beeperHost }}/v1/chats/search","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"query","value":"={{ $json.Phone }}"},{"name":"scope","value":"participants"},{"name":"type","value":"single"},{"name":"accountIDs","value":"imessage_c486047869de25aa846dda045493a09a"}]},"options":{}},"id":"ccd914bc-9ed5-472b-a0ed-46f796dfe9c3","name":"Search Missed Chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[10096,-480],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Searches Beeper for a DM chat matching the missed birthday person's phone number."},{"parameters":{"jsCode":"const searches = $input.all();\nconst people = $('Find Unsent Birthdays').all();\nconst host = $('Select Live Host').first().json.beeperHost;\n\nconst belatedTemplates = [\n  () => `Happy belated birthday! Hope you had an amazing day!`,\n  () => `Happy late birthday! Sorry I missed it!`,\n  () => `Better late than never — Happy birthday!`,\n  () => `Happy belated Birthday! Hope it was great!`,\n  () => `Late happy birthday! Wishing you the best!`,\n  () => `Happy belated birthday!! Hope it was a good one!`\n];\n\nreturn searches.map((search, i) => {\n  const person = people[i].json;\n  const items = search.json.items || [];\n  const chatID = items.length > 0 ? items[0].id : null;\n  const relay = String(person.Relay || '').toLowerCase() === 'true' || person.Relay === true;\n  let message;\n  if (relay) {\n    message = `Tell ${person.Name.split(' ')[0]} I said happy belated birthday!`;\n  } else {\n    const template = belatedTemplates[Math.floor(Math.random() * belatedTemplates.length)];\n    message = template();\n  }\n\n  return {\n    json: {\n      chatID: chatID ? encodeURIComponent(chatID) : null,\n      chatFound: chatID !== null,\n      name: person.Name,\n      phone: person.Phone,\n      beeperHost: host,\n      message: message\n    }\n  };\n});"},"id":"58a48ddc-901f-4877-aeb4-e6c3a80b82a1","name":"Extract Missed Chat ID","type":"n8n-nodes-base.code","typeVersion":2,"position":[10352,-480],"notes":"Pairs search results with missed birthday data. Picks a random belated greeting from 6 templates. No dinner follow-up for late birthdays."},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"cond_missed_chat_found","operator":{"type":"boolean","operation":"true","singleValue":true},"leftValue":"={{ $json.chatFound }}","rightValue":""}]},"options":{}},"id":"5b931e14-616f-467e-9cbe-8d143082be76","name":"Missed Chat Found?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[10608,-480],"notes":"TRUE: existing chat found, sends late birthday directly. FALSE: creates a new chat and sends the late birthday message."},{"parameters":{"method":"POST","url":"={{ $json.beeperHost }}/v1/chats/{{ $json.chatID }}/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\"text\": \"{{ $json.message }}\"}","options":{}},"id":"29cb2bc2-d5ca-4a4f-a404-87206c48b62d","name":"Send Late Birthday","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[10864,-576],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Sends the belated birthday greeting to an existing Beeper chat."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Date":"={{ new Date().toISOString() }}","Name":"={{ $('Missed Chat Found?').item.json.name }}","Phone":"={{ $('Missed Chat Found?').item.json.phone }}","Type":"late birthday (existing chat)","Message":"={{ $('Missed Chat Found?').item.json.message }}"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"bbd7d1c1-eb3d-4861-9e62-0896261d4f3e","name":"Log Late Birthday Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[11120,-576],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the late birthday send to the Sent-log sheet."},{"parameters":{"jsCode":"const accountID = \"imessage_c486047869de25aa846dda045493a09a\";\n\nreturn $(\"Missed Chat Found?\").all().map((data) => {\n  return {\n    json: {\n      accountID: accountID,\n      phone: data.json.phone,\n      beeperHost: data.json.beeperHost,\n      message: data.json.message,\n      name: data.json.name\n    }\n  };\n});"},"id":"fbd89ead-8ca6-4523-a893-b407efdd5de4","name":"Prepare Missed New Chat","type":"n8n-nodes-base.code","typeVersion":2,"position":[10864,-432],"notes":"Picks the accountID for new chat creation for missed birthdays. Uses the same preferred network as the main flow."},{"parameters":{"method":"POST","url":"={{ $json.beeperHost }}/v1/chats","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $env.BEEPER_API_KEY }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"accountID\": \"{{ $json.accountID }}\", \"participantIDs\": [\"{{ $json.phone }}\"], \"type\": \"single\"}","options":{}},"id":"ee25db9f-f2b4-4e88-b59b-3fd515afd5b1","name":"Create Missed Chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[11120,-432],"notes":"Creates a new Beeper chat with the phone number. Does not send a message — that happens in the next node."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Date":"={{ new Date().toISOString() }}","Name":"={{ $('Prepare Missed New Chat').item.json.name }}","Phone":"={{ $('Prepare Missed New Chat').item.json.phone }}","Type":"late birthday (new chat)","Message":"={{ $('Prepare Missed New Chat').item.json.message }}"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"5f834f1b-8fff-45af-9c63-7d22de5ea6d4","name":"Log Missed New Chat Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[11632,-432],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the late birthday new chat send to the Sent-log sheet."},{"parameters":{"method":"POST","url":"={{ $(\"Prepare Missed New Chat\").first().json.beeperHost }}/v1/chats/{{ encodeURIComponent($json.id) }}/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\"text\": \"{{ $(\"Prepare Missed New Chat\").first().json.message }}\"}","options":{}},"id":"119234ef-fc64-4dc2-a253-cab2a9030e3f","name":"Send Missed Birthday Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[11376,-432],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Sends the belated birthday message to the newly created chat."},{"parameters":{"documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"options":{}},"id":"53ae2ec7-5421-453c-b7bc-7482e093a365","name":"Read Sent Log Today","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[9584,-240],"executeOnce":true,"alwaysOutputData":true,"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Reads the Sent-log to check if today's birthday messages were already sent."},{"parameters":{"jsCode":"const todaysBirthdays = $('Filter Todays Birthdays').all();\nconst logEntries = $input.all();\nconst eightDaysAgo = new Date(Date.now() - 8 * 24 * 60 * 60 * 1000);\n\nconst recentLogs = logEntries.filter(log => {\n  const logDate = new Date(log.json.Date);\n  return !isNaN(logDate) && logDate >= eightDaysAgo;\n});\n\nconst unsent = todaysBirthdays.filter(tb => {\n  const phone = String(tb.json.Phone || '').trim().replace(/^\\+/, '');\n  return !recentLogs.some(log => {\n    const logPhone = String(log.json.Phone || '').trim().replace(/^\\+/, '');\n    const logType = String(log.json.Type || '').toLowerCase();\n    return logPhone === phone && logType.includes('birthday');\n  });\n});\n\nreturn unsent.map(tb => ({ json: { ...tb.json } }));"},"id":"3112c4b7-c437-4f2c-839b-9bcf1b2123c7","name":"Filter Unsent Today","type":"n8n-nodes-base.code","typeVersion":2,"position":[9840,-240],"notes":"Filters out anyone who already received a birthday message in the last 8 days. Prevents duplicate sends on re-runs."}],"connections":{"Manual Trigger":{"main":[[{"node":"Generate IP Candidates","type":"main","index":0}]]},"Random Delay":{"main":[[{"node":"Generate IP Candidates","type":"main","index":0}]]},"Generate IP Candidates":{"main":[[{"node":"Beeper Health Check","type":"main","index":0}]]},"Beeper Health Check":{"main":[[{"node":"Select Live Host","type":"main","index":0}]]},"Select Live Host":{"main":[[{"node":"Read Birthday Sheet","type":"main","index":0}]]},"Read Birthday Sheet":{"main":[[{"node":"Filter Todays Birthdays","type":"main","index":0},{"node":"Filter Missed Birthdays","type":"main","index":0}]]},"Filter Todays Birthdays":{"main":[[{"node":"Read Sent Log Today","type":"main","index":0}]]},"Search Chat by Phone":{"main":[[{"node":"Extract Chat ID","type":"main","index":0}]]},"Extract Chat ID":{"main":[[{"node":"Chat Found?","type":"main","index":0}]]},"Chat Found?":{"main":[[{"node":"Send Birthday Message","type":"main","index":0}],[{"node":"Prepare New Chat","type":"main","index":0}]]},"Send Birthday Message":{"main":[[{"node":"Log Birthday Send","type":"main","index":0}]]},"Log Birthday Send":{"main":[[{"node":"Dinner Plans?","type":"main","index":0}]]},"Dinner Plans?":{"main":[[{"node":"Dinner Delay","type":"main","index":0}]]},"Dinner Delay":{"main":[[{"node":"Send Dinner Message","type":"main","index":0}]]},"Send Dinner Message":{"main":[[{"node":"Log Dinner Send","type":"main","index":0}]]},"Prepare New Chat":{"main":[[{"node":"Create Chat & Send","type":"main","index":0}]]},"Create Chat & Send":{"main":[[{"node":"Log New Chat Send","type":"main","index":0}]]},"Log New Chat Send":{"main":[[{"node":"New Chat Dinner?","type":"main","index":0}]]},"New Chat Dinner?":{"main":[[{"node":"New Chat Dinner Delay","type":"main","index":0}]]},"New Chat Dinner Delay":{"main":[[{"node":"Send New Chat Dinner","type":"main","index":0}]]},"Send New Chat Dinner":{"main":[[{"node":"Log New Chat Dinner Send","type":"main","index":0}]]},"Daily 6AM Trigger":{"main":[[{"node":"Random Delay","type":"main","index":0}]]},"Filter Missed Birthdays":{"main":[[{"node":"Read Sent Log","type":"main","index":0}]]},"Read Sent Log":{"main":[[{"node":"Find Unsent Birthdays","type":"main","index":0}]]},"Find Unsent Birthdays":{"main":[[{"node":"Search Missed Chat","type":"main","index":0}]]},"Search Missed Chat":{"main":[[{"node":"Extract Missed Chat ID","type":"main","index":0}]]},"Extract Missed Chat ID":{"main":[[{"node":"Missed Chat Found?","type":"main","index":0}]]},"Missed Chat Found?":{"main":[[{"node":"Send Late Birthday","type":"main","index":0}],[{"node":"Prepare Missed New Chat","type":"main","index":0}]]},"Send Late Birthday":{"main":[[{"node":"Log Late Birthday Send","type":"main","index":0}]]},"Prepare Missed New Chat":{"main":[[{"node":"Create Missed Chat","type":"main","index":0}]]},"Create Missed Chat":{"main":[[{"node":"Send Missed Birthday Message","type":"main","index":0}]]},"Send Missed Birthday Message":{"main":[[{"node":"Log Missed New Chat Send","type":"main","index":0}]]},"Read Sent Log Today":{"main":[[{"node":"Filter Unsent Today","type":"main","index":0}]]},"Filter Unsent Today":{"main":[[{"node":"Search Chat by Phone","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","binaryMode":"separate","availableInMCP":false,"timeSavedMode":"fixed","errorWorkflow":"lumsfsJn-11VSs7gepTrz","callerPolicy":"workflowsFromSameOwner","timeSavedPerExecution":10},"staticData":{"node:Daily 6AM Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"a52cf13b-2d8f-4b7c-987c-f8b9a4af80f6","activeVersionId":"a52cf13b-2d8f-4b7c-987c-f8b9a4af80f6","versionCounter":584,"triggerCount":1,"shared":[{"updatedAt":"2026-02-06T14:16:30.280Z","createdAt":"2026-02-06T14:16:30.280Z","role":"workflow:owner","workflowId":"oA1s9hnoCiFdfVwB","projectId":"IbSEWMWujt4v9pwR","project":{"updatedAt":"2026-01-20T02:36:13.950Z","createdAt":"2025-12-27T17:56:55.369Z","id":"IbSEWMWujt4v9pwR","name":"Zac Clifton <zac16530@gmail.com>","type":"personal","icon":null,"description":null,"creatorId":"ec0e00c1-c94c-415c-8a06-1d74c6c63f94"}}],"tags":[],"activeVersion":{"updatedAt":"2026-02-16T00:07:26.591Z","createdAt":"2026-02-16T00:06:49.004Z","versionId":"a52cf13b-2d8f-4b7c-987c-f8b9a4af80f6","workflowId":"oA1s9hnoCiFdfVwB","nodes":[{"parameters":{},"id":"a185a801-00cb-4ad3-a319-b4b18ec1c311","name":"Manual Trigger","type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[8016,-48],"notes":"Click to test the full flow. Bypasses the Random Delay and uses the hardcoded phone number in Filter Todays Birthdays instead of reading from the Excel sheet."},{"parameters":{"amount":"={{ Math.floor(Math.random() * 27) + 1 }}","unit":"minutes"},"id":"7f633ec5-f24c-45d0-836a-a0b01291d89d","name":"Random Delay","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[8016,-240],"webhookId":"95f3e208-a850-470d-a07e-2f9f7d484a95","notes":"Waits a random 1-27 minutes so messages don't always arrive at exactly 6 AM."},{"parameters":{"jsCode":"return [\n  { json: { ip: '192.168.2.2' } },\n  { json: { ip: '192.168.10.181' } },\n  { json: { ip: '192.168.10.225' } }\n];"},"id":"7ba6c5e9-551c-439a-879f-f57a4c349d9a","name":"Generate IP Candidates","type":"n8n-nodes-base.code","typeVersion":2,"position":[8272,-240],"notes":"Add/remove IPs here if your laptop's addresses change."},{"parameters":{"url":"=http://{{ $json.ip }}:23373/v1/chats?limit=1","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{"timeout":5000}},"id":"8eadaae3-b890-4dd1-b8be-5b71e06a1789","name":"Beeper Health Check","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[8528,-240],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"continueOnFail":true,"notes":"Pings each IP on port 23373. continueOnFail lets failed IPs pass through so the next node can pick the live one. Requires Beeper Desktop to be running with Remote Access enabled and the BEEPER_API_KEY environment variable set in n8n."},{"parameters":{"jsCode":"const checks = $input.all();\nconst ips = $('Generate IP Candidates').all();\n\nfor (let i = 0; i < checks.length; i++) {\n  if (checks[i].json.items !== undefined) {\n    return [{ json: { beeperHost: 'http://' + ips[i].json.ip + ':23373' } }];\n  }\n}\n\nthrow new Error('Beeper Desktop not reachable on any configured IP. Ensure it is running with Remote Access enabled.');"},"id":"69176f82-3fc6-4ee5-95f3-5a7f4c3b550c","name":"Select Live Host","type":"n8n-nodes-base.code","typeVersion":2,"position":[8768,-240],"onError":"continueErrorOutput","notes":"Picks the first IP that returned a valid Beeper API response."},{"parameters":{"documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=0"},"options":{}},"id":"756d2aff-6c55-42f9-bd13-48e47f84c3fd","name":"Read Birthday Sheet","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[9024,-240],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Configure: 1) Set Google Sheets OAuth2 credential. 2) Paste your Google Sheet URL in the Document field.\\n\\nGoogle Sheet columns:\\n- Name: person's name (used in the birthday message)\\n- Birthday: supports MM-DD, MM/DD, YYYY-MM-DD, YYYY/MM/DD formats\\n- Phone: number without the + prefix (e.g. 14155552671). The workflow adds the + automatically since Google Sheets strips it\\n- Relay: boolean (TRUE/FALSE). If TRUE, sends 'Tell <Name> I said happy birthday!' to the Phone number instead of a direct greeting. Use this when the phone number belongs to someone else (e.g. sending to mom for the kid).\\n- Dinner: boolean (TRUE/FALSE). If TRUE, sends a follow-up message after 4-12 seconds asking about dinner plans."},{"parameters":{"jsCode":"const timeZone = 'America/New_York'; // Change to your timezone\nconst today = new Date().toLocaleDateString('en-US', { timeZone });\nconst [todayMonth, todayDay] = today.split('/').map(Number);\n\nreturn $input.all()\n  .filter(item => {\n    const phone = String(item.json.Phone || '').trim();\n    const bday = String(item.json.Birthday || '').trim();\n    if (!phone || !bday) return false;\n\n    // Strip invisible characters then split on / or -\n    const clean = bday.replace(/[^\\d\\/-]/g, '');\n    const parts = clean.split(/[\\/\\-]/);\n\n    let month, day;\n    if (parts.length === 3) {\n      if (parts[0].length === 4) {\n        // YYYY-MM-DD\n        month = parseInt(parts[1], 10);\n        day = parseInt(parts[2], 10);\n      } else {\n        // MM/DD/YYYY\n        month = parseInt(parts[0], 10);\n        day = parseInt(parts[1], 10);\n      }\n    } else if (parts.length === 2) {\n      // MM-DD or MM/DD\n      month = parseInt(parts[0], 10);\n      day = parseInt(parts[1], 10);\n    } else {\n      return false;\n    }\n\n    return month === todayMonth && day === todayDay;\n  })\n  .map(item => {\n    let phone = String(item.json.Phone).trim();\n    if (!phone.startsWith('+')) phone = '+' + phone;\n    return { json: { ...item.json, Phone: phone } };\n  });"},"id":"495225ca-c820-44b4-bc75-1aa1c61e18ff","name":"Filter Todays Birthdays","type":"n8n-nodes-base.code","typeVersion":2,"position":[9328,-240],"notes":"Supports MM-DD, MM/DD, YYYY-MM-DD, YYYY/MM/DD date formats. Skips rows with missing Phone or Birthday. Prepends '+' to phone numbers (Google Sheets strips the +)."},{"parameters":{"url":"={{ $('Select Live Host').first().json.beeperHost }}/v1/chats/search","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"query","value":"={{ $json.Phone }}"},{"name":"scope","value":"participants"},{"name":"type","value":"single"},{"name":"accountIDs","value":"imessage_c486047869de25aa846dda045493a09a"}]},"options":{}},"id":"81c930f0-d7de-4b23-a5fd-e63869ee2e83","name":"Search Chat by Phone","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[10288,-240],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Searches Beeper for a DM chat matching this phone number. Phone must be in E.164 format (+country code + number) to match correctly."},{"parameters":{"jsCode":"const searches = $input.all();\nconst people = $('Filter Todays Birthdays').all();\nconst host = $('Select Live Host').first().json.beeperHost;\n\nconst directTemplates = [\n  () => `Happy Birthday! \\ud83c\\udf82 Hope your day is as sweet as cake!`,\n  () => `Happy Birthday!!! \\ud83c\\udf89\\ud83c\\udf89\\ud83c\\udf89`,\n  () => `It's your birthday! \\ud83c\\udf88\\ud83c\\udf88 Sending you all the balloons!`,\n  () => `Happy Birthday! \\ud83c\\udf1f Hope it's a great one!`,\n  () => `Wishing you a wonderful birthday! \\ud83e\\udd73\\ud83c\\udf8a`,\n  () => `Happy Birthday! \\ud83c\\udf82\\ud83c\\udf88\\ud83c\\udf81 Party time!`,\n  () => `Happy birthday!! \\ud83e\\udd42 Cheers to another year!`\n];\n\nreturn searches.map((search, i) => {\n  const person = people[i].json;\n  const items = search.json.items || [];\n  const chatID = items.length > 0 ? items[0].id : null;\n  const relay = String(person.Relay || '').toLowerCase() === 'true' || person.Relay === true;\n  let message;\n  if (relay) {\n    message = `Tell ${person.Name.split(\" \")[0]} I said happy birthday!`;\n  } else {\n    const template = directTemplates[Math.floor(Math.random() * directTemplates.length)];\n    message = template();\n  }\n\n  const dinner = String(person.Dinner || '').toLowerCase() === 'true' || person.Dinner === true;\n\n  const dinnerTemplates = [\n    'Want to grab dinner sometime to celebrate?',\n    'Lets do a birthday dinner soon!',\n    'Let me know if you want to grab dinner sometime to celebrate!',\n    'Down for a birthday dinner sometime soon?'\n  ];\n  const dinnerMessage = dinnerTemplates[Math.floor(Math.random() * dinnerTemplates.length)];\n\n  return {\n    json: {\n      chatID: chatID ? encodeURIComponent(chatID) : null,\n      chatFound: chatID !== null,\n      name: person.Name,\n      phone: person.Phone,\n      beeperHost: host,\n      message: message,\n      dinner: dinner,\n      dinnerMessage: dinnerMessage\n    }\n  };\n});"},"id":"5d9cb2e7-5a3d-451d-8120-eb337d655f8d","name":"Extract Chat ID","type":"n8n-nodes-base.code","typeVersion":2,"position":[10528,-240],"notes":"Pairs search results with person data from the birthday filter. Picks a random greeting from 8 templates. If Relay is true, sends 'Tell <Name> I said happy birthday!' instead."},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"cond_chat_found","operator":{"type":"boolean","operation":"true","singleValue":true},"leftValue":"={{ $json.chatFound }}","rightValue":""}]},"options":{}},"id":"0f3d48e7-c55b-4998-92c2-109b8e303f22","name":"Chat Found?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[10784,-240],"notes":"TRUE: existing chat found, sends message directly. FALSE: no chat found, creates a new chat and sends the message via the Create Chat API."},{"parameters":{"method":"POST","url":"={{ $json.beeperHost }}/v1/chats/{{ $json.chatID }}/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\"text\": \"{{ $json.message }}\"}","options":{}},"id":"0413a79c-746a-4b09-9bb5-f0587551e624","name":"Send Birthday Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[11040,-240],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Sends the birthday greeting via Beeper Desktop API v1."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Date":"={{ new Date().toISOString() }}","Name":"={{ $('Chat Found?').item.json.name }}","Message":"={{ $('Chat Found?').item.json.message }}","Phone":"={{ $('Chat Found?').item.json.phone }}","Type":"birthday (existing chat)"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"ee78201b-62b9-4ab5-a45b-98023d6654c3","name":"Log Birthday Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[11280,-240],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the birthday message send to the 'Log' sheet tab. Configure: set the same Google Sheet URL and OAuth2 credential as 'Read Birthday Sheet'. Create a 'Log' sheet tab with columns: Date, Name, Phone, Type, Message."},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"cond_dinner","operator":{"type":"boolean","operation":"true","singleValue":true},"leftValue":"={{ $('Extract Chat ID').item.json.dinner }}","rightValue":""}]},"options":{}},"id":"f2b96a01-1c08-413b-9846-23e5d69fb311","name":"Dinner Plans?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[11536,-240],"notes":"Checks if the Dinner column is TRUE for this person."},{"parameters":{"amount":"={{ Math.floor(Math.random() * 9) + 4 }}"},"id":"dc9997bf-0476-4ba5-982f-2e5e926145c1","name":"Dinner Delay","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[11792,-240],"webhookId":"059e9f53-6fdb-4327-91ec-70c6a2397488","notes":"Waits a random 4-12 seconds before sending the dinner follow-up so it feels natural."},{"parameters":{"method":"POST","url":"={{ $('Extract Chat ID').item.json.beeperHost }}/v1/chats/{{ $('Extract Chat ID').item.json.chatID }}/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\"text\": \"{{ $('Extract Chat ID').item.json.dinnerMessage }}\"}","options":{}},"id":"09b698f5-3df3-4614-af3a-493fcfae6188","name":"Send Dinner Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[12032,-240],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Sends a follow-up message asking about dinner plans."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Message":"={{ $('Chat Found?').item.json.message }}","Name":"={{ $('Chat Found?').item.json.name }}","Phone":"={{ $('Chat Found?').item.json.phone }}","Type":"Birthday Dinner (existing chat)","Date":"={{ new Date().toISOString() }}"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"965186ab-0232-4c36-9980-d3ad192b3e77","name":"Log Dinner Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[12288,-240],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the dinner follow-up send to the 'Log' sheet tab."},{"parameters":{"jsCode":"const accountID = \"imessage_c486047869de25aa846dda045493a09a\";\n\nreturn $(\"Chat Found?\").all().map((data) => {\n  return {\n    json: {\n      accountID: accountID,\n      phone: data.json.phone,\n      beeperHost: data.json.beeperHost,\n      message: data.json.message,\n      name: data.json.name,\n      dinner: data.json.dinner,\n      dinnerMessage: data.json.dinnerMessage\n    }\n  };\n});"},"id":"e7e97c8f-b160-408a-b3d5-fc2645112920","name":"Prepare New Chat","type":"n8n-nodes-base.code","typeVersion":2,"position":[11040,32],"notes":"Picks the accountID for chat creation. Change preferredNetwork to match your primary messaging service (iMessage, WhatsApp, etc.)."},{"parameters":{"method":"POST","url":"={{ $json.beeperHost }}/v1/chats","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $env.BEEPER_API_KEY }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"accountID\": \"{{ $json.accountID }}\", \"participantIDs\": [\"{{ $json.phone }}\"], \"type\": \"single\", \"messageText\": \"{{ $json.message }}\"}","options":{}},"id":"097df7c5-1679-44fc-9c47-bf52e0c22ffc","name":"Create Chat & Send","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[11280,32],"notes":"Creates a new Beeper chat with the phone number and sends the birthday message as the first message via the messageText field."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Date":"={{ new Date().toISOString() }}","Name":"={{ $('Prepare New Chat').item.json.name }}","Phone":"={{ $('Prepare New Chat').item.json.phone }}","Type":"birthday (new chat)","Message":"={{ $('Prepare New Chat').item.json.message }}"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}]},"options":{}},"id":"d17f6d0f-674f-46b2-ab1a-df1078531202","name":"Log New Chat Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[11536,32],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the new chat birthday send to the 'Log' sheet tab."},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"cond_new_dinner","operator":{"type":"boolean","operation":"true","singleValue":true},"leftValue":"={{ $('Prepare New Chat').item.json.dinner }}","rightValue":""}]},"options":{}},"id":"104bbcd7-6f46-4dc9-9d83-61a1e00b15ae","name":"New Chat Dinner?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[11792,32],"notes":"Checks dinner flag for newly created chats."},{"parameters":{"amount":"={{ Math.floor(Math.random() * 9) + 4 }}"},"id":"dddd991e-cd35-4298-9f2d-90d38c3127a3","name":"New Chat Dinner Delay","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[12032,32],"webhookId":"fa57ba51-cf58-4468-9514-fab7f3c1992f","notes":"Random 4-12 second delay before dinner follow-up on new chat."},{"parameters":{"method":"POST","url":"={{ $('Prepare New Chat').item.json.beeperHost }}/v1/chats/{{ encodeURIComponent($('Create Chat & Send').item.json.chatID) }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $env.BEEPER_API_KEY }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"text\": \"{{ $('Prepare New Chat').item.json.dinnerMessage }}\"}","options":{}},"id":"97bfc563-7ad7-4c04-8daa-a916567ef090","name":"Send New Chat Dinner","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[12288,32],"notes":"Sends dinner follow-up to the newly created chat."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Date":"={{ new Date().toISOString() }}","Name":"={{ $('Prepare New Chat').item.json.name }}","Phone":"={{ $('Prepare New Chat').item.json.phone }}","Type":"dinner (new chat)","Message":"={{ $('Prepare New Chat').item.json.dinnerMessage }}"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}]},"options":{}},"id":"d3df4d9b-d962-476f-85b7-1e5d1906720b","name":"Log New Chat Dinner Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[12528,32],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the new chat dinner follow-up send to the 'Log' sheet tab."},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"0 6-22 * * *"}]}},"id":"179f6e2c-27a6-446a-a9ca-db1c1a080f03","name":"Daily 6AM Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[7776,-240],"notes":"Runs daily at 6 AM. Adjust triggerAtHour for your timezone."},{"parameters":{"jsCode":"const timeZone = 'America/New_York';\nconst today = new Date().toLocaleDateString('en-US', { timeZone });\nconst [todayMonth, todayDay] = today.split('/').map(Number);\n\nconst missedDates = [];\nfor (let i = 1; i <= 7; i++) {\n  const d = new Date();\n  d.setDate(d.getDate() - i);\n  const ds = d.toLocaleDateString('en-US', { timeZone });\n  const [m, day] = ds.split('/').map(Number);\n  missedDates.push({ month: m, day: day, daysLate: i });\n}\n\nreturn $input.all()\n  .map(item => {\n    const phone = String(item.json.Phone || '').trim();\n    const bday = String(item.json.Birthday || '').trim();\n    if (!phone || !bday) return null;\n\n    const clean = bday.replace(/[^\\d\\/-]/g, '');\n    const parts = clean.split(/[\\/\\-]/);\n\n    let month, day;\n    if (parts.length === 3) {\n      if (parts[0].length === 4) {\n        month = parseInt(parts[1], 10);\n        day = parseInt(parts[2], 10);\n      } else {\n        month = parseInt(parts[0], 10);\n        day = parseInt(parts[1], 10);\n      }\n    } else if (parts.length === 2) {\n      month = parseInt(parts[0], 10);\n      day = parseInt(parts[1], 10);\n    } else {\n      return null;\n    }\n\n    const match = missedDates.find(d => d.month === month && d.day === day);\n    if (!match) return null;\n\n    let phoneClean = phone;\n    if (!phoneClean.startsWith('+')) phoneClean = '+' + phoneClean;\n\n    return { json: { ...item.json, Phone: phoneClean, daysLate: match.daysLate } };\n  })\n  .filter(item => item !== null);"},"id":"676bf6b3-549d-4f60-adac-761a8c8dc8d9","name":"Filter Missed Birthdays","type":"n8n-nodes-base.code","typeVersion":2,"position":[9328,-480],"notes":"Checks last 7 days for birthdays that may have been missed. Same date parsing as Filter Todays Birthdays. Outputs matching rows with daysLate field."},{"parameters":{"documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"options":{}},"id":"984a10c6-a62c-4db4-a332-9710b1bd618f","name":"Read Sent Log","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[9584,-480],"executeOnce":true,"alwaysOutputData":true,"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Reads all entries from the Sent-log sheet to check which birthdays were already sent."},{"parameters":{"jsCode":"const missedBirthdays = $('Filter Missed Birthdays').all();\nconst logEntries = $input.all();\nconst fourteenDaysAgo = new Date(Date.now() - 8 * 24 * 60 * 60 * 1000);\n\n// Filter log to last 8 days only\nconst recentLogs = logEntries.filter(log => {\n  const logDate = new Date(log.json.Date);\n  return !isNaN(logDate) && logDate >= fourteenDaysAgo;\n});\n\nconst unsent = missedBirthdays.filter(mb => {\n  const phone = String(mb.json.Phone || '').trim().replace(/^\\+/, '');\n  return !recentLogs.some(log => {\n    const logPhone = String(log.json.Phone || '').trim().replace(/^\\+/, '');\n    const logType = String(log.json.Type || '').toLowerCase();\n    return logPhone === phone && logType.includes('birthday');\n  });\n});\n\nreturn unsent.map(mb => ({ json: { ...mb.json } }));"},"id":"bd2adada-0768-4dea-95bd-37fbd503adee","name":"Find Unsent Birthdays","type":"n8n-nodes-base.code","typeVersion":2,"position":[9840,-480],"notes":"Cross-references missed birthdays with the Sent-log. Filters out anyone who already received a birthday message in the last 8 days."},{"parameters":{"url":"={{ $('Select Live Host').first().json.beeperHost }}/v1/chats/search","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"query","value":"={{ $json.Phone }}"},{"name":"scope","value":"participants"},{"name":"type","value":"single"},{"name":"accountIDs","value":"imessage_c486047869de25aa846dda045493a09a"}]},"options":{}},"id":"ccd914bc-9ed5-472b-a0ed-46f796dfe9c3","name":"Search Missed Chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[10096,-480],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Searches Beeper for a DM chat matching the missed birthday person's phone number."},{"parameters":{"jsCode":"const searches = $input.all();\nconst people = $('Find Unsent Birthdays').all();\nconst host = $('Select Live Host').first().json.beeperHost;\n\nconst belatedTemplates = [\n  () => `Happy belated birthday! Hope you had an amazing day!`,\n  () => `Happy late birthday! Sorry I missed it!`,\n  () => `Better late than never — Happy birthday!`,\n  () => `Happy belated Birthday! Hope it was great!`,\n  () => `Late happy birthday! Wishing you the best!`,\n  () => `Happy belated birthday!! Hope it was a good one!`\n];\n\nreturn searches.map((search, i) => {\n  const person = people[i].json;\n  const items = search.json.items || [];\n  const chatID = items.length > 0 ? items[0].id : null;\n  const relay = String(person.Relay || '').toLowerCase() === 'true' || person.Relay === true;\n  let message;\n  if (relay) {\n    message = `Tell ${person.Name.split(' ')[0]} I said happy belated birthday!`;\n  } else {\n    const template = belatedTemplates[Math.floor(Math.random() * belatedTemplates.length)];\n    message = template();\n  }\n\n  return {\n    json: {\n      chatID: chatID ? encodeURIComponent(chatID) : null,\n      chatFound: chatID !== null,\n      name: person.Name,\n      phone: person.Phone,\n      beeperHost: host,\n      message: message\n    }\n  };\n});"},"id":"58a48ddc-901f-4877-aeb4-e6c3a80b82a1","name":"Extract Missed Chat ID","type":"n8n-nodes-base.code","typeVersion":2,"position":[10352,-480],"notes":"Pairs search results with missed birthday data. Picks a random belated greeting from 6 templates. No dinner follow-up for late birthdays."},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"cond_missed_chat_found","operator":{"type":"boolean","operation":"true","singleValue":true},"leftValue":"={{ $json.chatFound }}","rightValue":""}]},"options":{}},"id":"5b931e14-616f-467e-9cbe-8d143082be76","name":"Missed Chat Found?","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[10608,-480],"notes":"TRUE: existing chat found, sends late birthday directly. FALSE: creates a new chat and sends the late birthday message."},{"parameters":{"method":"POST","url":"={{ $json.beeperHost }}/v1/chats/{{ $json.chatID }}/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\"text\": \"{{ $json.message }}\"}","options":{}},"id":"29cb2bc2-d5ca-4a4f-a404-87206c48b62d","name":"Send Late Birthday","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[10864,-576],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Sends the belated birthday greeting to an existing Beeper chat."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Date":"={{ new Date().toISOString() }}","Name":"={{ $('Missed Chat Found?').item.json.name }}","Phone":"={{ $('Missed Chat Found?').item.json.phone }}","Type":"late birthday (existing chat)","Message":"={{ $('Missed Chat Found?').item.json.message }}"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"bbd7d1c1-eb3d-4861-9e62-0896261d4f3e","name":"Log Late Birthday Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[11120,-576],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the late birthday send to the Sent-log sheet."},{"parameters":{"jsCode":"const accountID = \"imessage_c486047869de25aa846dda045493a09a\";\n\nreturn $(\"Missed Chat Found?\").all().map((data) => {\n  return {\n    json: {\n      accountID: accountID,\n      phone: data.json.phone,\n      beeperHost: data.json.beeperHost,\n      message: data.json.message,\n      name: data.json.name\n    }\n  };\n});"},"id":"fbd89ead-8ca6-4523-a893-b407efdd5de4","name":"Prepare Missed New Chat","type":"n8n-nodes-base.code","typeVersion":2,"position":[10864,-432],"notes":"Picks the accountID for new chat creation for missed birthdays. Uses the same preferred network as the main flow."},{"parameters":{"method":"POST","url":"={{ $json.beeperHost }}/v1/chats","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $env.BEEPER_API_KEY }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"accountID\": \"{{ $json.accountID }}\", \"participantIDs\": [\"{{ $json.phone }}\"], \"type\": \"single\"}","options":{}},"id":"ee25db9f-f2b4-4e88-b59b-3fd515afd5b1","name":"Create Missed Chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[11120,-432],"notes":"Creates a new Beeper chat with the phone number. Does not send a message — that happens in the next node."},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"columns":{"mappingMode":"defineBelow","value":{"Date":"={{ new Date().toISOString() }}","Name":"={{ $('Prepare Missed New Chat').item.json.name }}","Phone":"={{ $('Prepare Missed New Chat').item.json.phone }}","Type":"late birthday (new chat)","Message":"={{ $('Prepare Missed New Chat').item.json.message }}"},"matchingColumns":[],"schema":[{"id":"Date","displayName":"Date","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Name","displayName":"Name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Phone","displayName":"Phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Type","displayName":"Type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Message","displayName":"Message","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"5f834f1b-8fff-45af-9c63-7d22de5ea6d4","name":"Log Missed New Chat Send","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[11632,-432],"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Logs the late birthday new chat send to the Sent-log sheet."},{"parameters":{"method":"POST","url":"={{ $(\"Prepare Missed New Chat\").first().json.beeperHost }}/v1/chats/{{ encodeURIComponent($json.id) }}/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"={\"text\": \"{{ $(\"Prepare Missed New Chat\").first().json.message }}\"}","options":{}},"id":"119234ef-fc64-4dc2-a253-cab2a9030e3f","name":"Send Missed Birthday Message","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[11376,-432],"credentials":{"httpBearerAuth":{"id":"KjkXMcrn8n8y2LPH","name":"Zac Beeper Bearer Auth Token"}},"notes":"Sends the belated birthday message to the newly created chat."},{"parameters":{"documentId":{"__rl":true,"value":"1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY","mode":"list","cachedResultName":"Birthday Sheet","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":302173508,"mode":"list","cachedResultName":"Sent-log","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1nrqFiDiJctgRckapXP9F7VuN9-p7NPAMwCompmhJthY/edit#gid=302173508"},"options":{}},"id":"53ae2ec7-5421-453c-b7bc-7482e093a365","name":"Read Sent Log Today","type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[9584,-240],"executeOnce":true,"alwaysOutputData":true,"credentials":{"googleSheetsOAuth2Api":{"id":"g34vKL5UNRBGONR7","name":"Zac Google Sheets account"}},"notes":"Reads the Sent-log to check if today's birthday messages were already sent."},{"parameters":{"jsCode":"const todaysBirthdays = $('Filter Todays Birthdays').all();\nconst logEntries = $input.all();\nconst eightDaysAgo = new Date(Date.now() - 8 * 24 * 60 * 60 * 1000);\n\nconst recentLogs = logEntries.filter(log => {\n  const logDate = new Date(log.json.Date);\n  return !isNaN(logDate) && logDate >= eightDaysAgo;\n});\n\nconst unsent = todaysBirthdays.filter(tb => {\n  const phone = String(tb.json.Phone || '').trim().replace(/^\\+/, '');\n  return !recentLogs.some(log => {\n    const logPhone = String(log.json.Phone || '').trim().replace(/^\\+/, '');\n    const logType = String(log.json.Type || '').toLowerCase();\n    return logPhone === phone && logType.includes('birthday');\n  });\n});\n\nreturn unsent.map(tb => ({ json: { ...tb.json } }));"},"id":"3112c4b7-c437-4f2c-839b-9bcf1b2123c7","name":"Filter Unsent Today","type":"n8n-nodes-base.code","typeVersion":2,"position":[9840,-240],"notes":"Filters out anyone who already received a birthday message in the last 8 days. Prevents duplicate sends on re-runs."}],"connections":{"Manual Trigger":{"main":[[{"node":"Generate IP Candidates","type":"main","index":0}]]},"Random Delay":{"main":[[{"node":"Generate IP Candidates","type":"main","index":0}]]},"Generate IP Candidates":{"main":[[{"node":"Beeper Health Check","type":"main","index":0}]]},"Beeper Health Check":{"main":[[{"node":"Select Live Host","type":"main","index":0}]]},"Select Live Host":{"main":[[{"node":"Read Birthday Sheet","type":"main","index":0}]]},"Read Birthday Sheet":{"main":[[{"node":"Filter Todays Birthdays","type":"main","index":0},{"node":"Filter Missed Birthdays","type":"main","index":0}]]},"Filter Todays Birthdays":{"main":[[{"node":"Read Sent Log Today","type":"main","index":0}]]},"Search Chat by Phone":{"main":[[{"node":"Extract Chat ID","type":"main","index":0}]]},"Extract Chat ID":{"main":[[{"node":"Chat Found?","type":"main","index":0}]]},"Chat Found?":{"main":[[{"node":"Send Birthday Message","type":"main","index":0}],[{"node":"Prepare New Chat","type":"main","index":0}]]},"Send Birthday Message":{"main":[[{"node":"Log Birthday Send","type":"main","index":0}]]},"Log Birthday Send":{"main":[[{"node":"Dinner Plans?","type":"main","index":0}]]},"Dinner Plans?":{"main":[[{"node":"Dinner Delay","type":"main","index":0}]]},"Dinner Delay":{"main":[[{"node":"Send Dinner Message","type":"main","index":0}]]},"Send Dinner Message":{"main":[[{"node":"Log Dinner Send","type":"main","index":0}]]},"Prepare New Chat":{"main":[[{"node":"Create Chat & Send","type":"main","index":0}]]},"Create Chat & Send":{"main":[[{"node":"Log New Chat Send","type":"main","index":0}]]},"Log New Chat Send":{"main":[[{"node":"New Chat Dinner?","type":"main","index":0}]]},"New Chat Dinner?":{"main":[[{"node":"New Chat Dinner Delay","type":"main","index":0}]]},"New Chat Dinner Delay":{"main":[[{"node":"Send New Chat Dinner","type":"main","index":0}]]},"Send New Chat Dinner":{"main":[[{"node":"Log New Chat Dinner Send","type":"main","index":0}]]},"Daily 6AM Trigger":{"main":[[{"node":"Random Delay","type":"main","index":0}]]},"Filter Missed Birthdays":{"main":[[{"node":"Read Sent Log","type":"main","index":0}]]},"Read Sent Log":{"main":[[{"node":"Find Unsent Birthdays","type":"main","index":0}]]},"Find Unsent Birthdays":{"main":[[{"node":"Search Missed Chat","type":"main","index":0}]]},"Search Missed Chat":{"main":[[{"node":"Extract Missed Chat ID","type":"main","index":0}]]},"Extract Missed Chat ID":{"main":[[{"node":"Missed Chat Found?","type":"main","index":0}]]},"Missed Chat Found?":{"main":[[{"node":"Send Late Birthday","type":"main","index":0}],[{"node":"Prepare Missed New Chat","type":"main","index":0}]]},"Send Late Birthday":{"main":[[{"node":"Log Late Birthday Send","type":"main","index":0}]]},"Prepare Missed New Chat":{"main":[[{"node":"Create Missed Chat","type":"main","index":0}]]},"Create Missed Chat":{"main":[[{"node":"Send Missed Birthday Message","type":"main","index":0}]]},"Send Missed Birthday Message":{"main":[[{"node":"Log Missed New Chat Send","type":"main","index":0}]]},"Read Sent Log Today":{"main":[[{"node":"Filter Unsent Today","type":"main","index":0}]]},"Filter Unsent Today":{"main":[[{"node":"Search Chat by Phone","type":"main","index":0}]]}},"authors":"Zac Clifton","name":"Version a52cf13b","description":"","autosaved":true,"workflowPublishHistory":[{"createdAt":"2026-02-16T00:07:26.574Z","id":35,"workflowId":"oA1s9hnoCiFdfVwB","versionId":"a52cf13b-2d8f-4b7c-987c-f8b9a4af80f6","event":"activated","userId":"ec0e00c1-c94c-415c-8a06-1d74c6c63f94"}]}}