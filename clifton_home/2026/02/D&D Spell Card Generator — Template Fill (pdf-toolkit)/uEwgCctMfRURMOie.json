{"updatedAt":"2026-02-15T23:29:29.665Z","createdAt":"2026-02-15T23:18:53.716Z","id":"uEwgCctMfRURMOie","name":"D&D Spell Card Generator â€” Template Fill (pdf-toolkit)","description":null,"active":false,"isArchived":true,"nodes":[{"parameters":{},"id":"0083b30d-4b9e-4b38-80f9-bcf760a1374b","name":"Start","type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-112,272]},{"parameters":{"assignments":{"assignments":[{"id":"a01","name":"sourcePdfPath","value":"/data/spell-source/310286922-Necromancy-5e.pdf","type":"string"},{"id":"a02","name":"templateDir","value":"/data/spell-templates","type":"string"},{"id":"a03","name":"outputDir","value":"/data/spell-output","type":"string"},{"id":"a04","name":"tempDir","value":"/tmp/spell-pages","type":"string"},{"id":"a05","name":"classes","value":"bard,cleric,druid,paladin,ranger,sorcerer,warlock,wizard","type":"string"}]},"options":{}},"id":"13036ddd-9904-4e90-97f7-5bd99be756a5","name":"âš™ï¸ Configuration","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[128,272]},{"parameters":{"jsCode":"const input = $input.first().json;\nlet text = input.text || input.data || '';\nif (!text && $input.first().binary?.data) {\n  text = Buffer.from($input.first().binary.data.data, 'base64').toString('utf-8');\n}\nif (!text || text.length < 100) throw new Error('Text extraction failed');\nreturn [{ json: { extractedText: text } }];"},"id":"7a623adf-bd03-4571-9d61-f8d9c1a43210","name":"Normalize Text","type":"n8n-nodes-base.code","typeVersion":2,"position":[720,288]},{"parameters":{"jsCode":"// =================================================================\n// Parse AI response and create a FLAT list of ALL batches to fill.\n// Each item = one template fill operation (up to 8 spells).\n// =================================================================\nconst resp = $input.first().json;\nconst content = resp?.content?.[0]?.text || resp?.body?.content?.[0]?.text || '';\nconst m = content.match(/```json\\s*([\\s\\S]*?)```/);\nif (!m) throw new Error('No JSON block in AI response');\nlet data;\ntry { data = JSON.parse(m[1].trim()); }\ncatch (e) { throw new Error('JSON parse: ' + e.message); }\n\nconst cfg = $('âš™ï¸ Configuration').first().json;\nconst CARDS_PER_PAGE = 8;\n\n// PDF form field name mapping:\n// Slot i â†’ row = floor(i/4), col = i%4\n// Field patterns discovered from template:\n//   Spell 1.{row}.{col}              â†’ title\n//   CASTING TIME.{row}.{col}          â†’ cast_time\n//   RANGE.{row}.{col}                 â†’ range\n//   COMPONENTS.{row}.{col}            â†’ components\n//   DURATION.{row}.{col}              â†’ duration\n//   Component_List.0.0.{row}.{col}    â†’ comp_list\n//   Description.0.0.{row}.{col}       â†’ desc\n//   Class.0.0.{row}.{col}             â†’ class_line + source\n\nfunction buildFieldMappings(spells) {\n  const fields = [];\n  for (let i = 0; i < spells.length; i++) {\n    const sp = spells[i];\n    const row = Math.floor(i / 4);\n    const col = i % 4;\n    fields.push(\n      { key: `Spell 1.${row}.${col}`, value: sp.title, type: 'textfield' },\n      { key: `CASTING TIME.${row}.${col}`, value: sp.cast_time, type: 'textfield' },\n      { key: `RANGE.${row}.${col}`, value: sp.range, type: 'textfield' },\n      { key: `COMPONENTS.${row}.${col}`, value: sp.components, type: 'textfield' },\n      { key: `DURATION.${row}.${col}`, value: sp.duration, type: 'textfield' },\n      { key: `Component_List.0.0.${row}.${col}`, value: sp.comp_list || '', type: 'textfield' },\n      { key: `Description.0.0.${row}.${col}`, value: sp.desc, type: 'textfield' },\n      { key: `Class.0.0.${row}.${col}`, value: `${sp.class_line}     ${sp.source}`, type: 'textfield' }\n    );\n  }\n  return fields;\n}\n\nconst allBatches = [];\nfor (const cls of cfg.classes.split(',')) {\n  const cd = data.classes?.[cls];\n  if (!cd) continue;\n  const spells = [];\n  for (const lvl of ['cantrips','1st','2nd','3rd','4th','5th','6th','7th','8th','9th'])\n    if (cd[lvl] && Array.isArray(cd[lvl])) spells.push(...cd[lvl]);\n  if (!spells.length) continue;\n\n  const totalBatches = Math.ceil(spells.length / CARDS_PER_PAGE);\n  for (let bi = 0; bi < totalBatches; bi++) {\n    const batch = spells.slice(bi * CARDS_PER_PAGE, (bi + 1) * CARDS_PER_PAGE);\n    allBatches.push({\n      json: {\n        className: cls,\n        batchIndex: bi,\n        totalBatches,\n        spellCount: spells.length,\n        batchSpellCount: batch.length,\n        templatePath: `${cfg.templateDir}/spell-cards-${cls}.pdf`,\n        tempPath: `${cfg.tempDir}/${cls}_${String(bi).padStart(2,'0')}.pdf`,\n        outputPath: `${cfg.outputDir}/spell-cards-${cls}-filled.pdf`,\n        fields: buildFieldMappings(batch)\n      }\n    });\n  }\n}\n\nconsole.log(`Generated ${allBatches.length} fill operations:`);\nconst classMap = {};\nfor (const b of allBatches) {\n  const c = b.json.className;\n  classMap[c] = (classMap[c] || 0) + 1;\n}\nfor (const [c, n] of Object.entries(classMap)) console.log(`  ${c}: ${n} pages`);\n\nreturn allBatches;"},"id":"808ea321-d44b-43cd-8401-05afee6b95f2","name":"ğŸ“‹ Parse All Batches","type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,288],"notes":"Creates a FLAT list of fill operations. Each item = one template page (8 spells max) with the exact PDF form field mappings.\n\nField names match the template structure:\n  Spell 1.{row}.{col} â†’ title\n  CASTING TIME.{row}.{col} â†’ cast time\n  RANGE.{row}.{col} â†’ range\n  COMPONENTS.{row}.{col} â†’ components\n  DURATION.{row}.{col} â†’ duration\n  Component_List.0.0.{row}.{col} â†’ materials\n  Description.0.0.{row}.{col} â†’ description\n  Class.0.0.{row}.{col} â†’ class/level + source"},{"parameters":{"options":{}},"id":"f869dccb-f221-4bff-ac20-9818d80acfc4","name":"ğŸ”„ Fill Loop","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1600,256],"disabled":true,"notes":"Processes each batch one at a time:\nRead template â†’ Fill form fields â†’ Save temp file"},{"parameters":{"operation":"readFile"},"id":"9cf00726-b195-474f-b1c8-928607cc6fc2","name":"ğŸ“– Read Template","type":"n8n-nodes-base.readWriteFile","typeVersion":1,"position":[2240,272],"notes":"Reads the class template PDF as binary for the Fill Form node"},{"parameters":{"operation":"writeFile"},"id":"5ae6abd2-2997-49f7-a438-521bfb5a5b7c","name":"ğŸ’¾ Save Temp Page","type":"n8n-nodes-base.readWriteFile","typeVersion":1,"position":[2672,272],"notes":"Saves each filled 2-page PDF (front+back) to a temp file.\nNaming: /tmp/spell-pages/{class}_{batchIndex}.pdf"},{"parameters":{"jsCode":"// ================================================================\n// After all fills are done, group temp files by class.\n// Output one item per class with its list of temp file paths.\n// ================================================================\nconst fs = require('fs');\nconst cfg = $('âš™ï¸ Configuration').first().json;\nconst tempDir = cfg.tempDir;\n\n// Read all temp files and group by class\nconst files = fs.readdirSync(tempDir).filter(f => f.endsWith('.pdf')).sort();\nconst classMap = {};\n\nfor (const f of files) {\n  const cls = f.split('_')[0];\n  if (!classMap[cls]) classMap[cls] = [];\n  classMap[cls].push(`${tempDir}/${f}`);\n}\n\nconst output = [];\nfor (const [cls, paths] of Object.entries(classMap)) {\n  output.push({\n    json: {\n      className: cls,\n      tempFiles: paths,\n      pageCount: paths.length,\n      needsMerge: paths.length > 1,\n      outputPath: `${cfg.outputDir}/spell-cards-${cls}-filled.pdf`\n    }\n  });\n}\n\nconsole.log(`Classes to merge: ${output.length}`);\nfor (const o of output) console.log(`  ${o.json.className}: ${o.json.pageCount} pages (merge=${o.json.needsMerge})`);\n\nreturn output;"},"id":"26dd013c-7468-4fdb-98ba-6802774b8ab1","name":"ğŸ“‹ Group By Class","type":"n8n-nodes-base.code","typeVersion":2,"position":[1824,640],"notes":"Reads temp directory, groups files by class name.\nOutputs one item per class with file paths and merge flag."},{"parameters":{"options":{}},"id":"b5ab7f4d-3cab-4fbf-92d9-39d21cd2b743","name":"ğŸ”„ Merge Loop","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[2048,640],"notes":"Processes one class at a time: load its temp PDFs â†’ merge â†’ save final"},{"parameters":{"jsCode":"// ================================================================\n// Load all temp PDFs for this class as binary items.\n// If only 1 file (no merge needed), just output it directly.\n// If multiple files, output N items for the Merge node.\n// ================================================================\nconst fs = require('fs');\nconst item = $input.first().json;\n\nif (!item.needsMerge) {\n  // Single file â€” just read it and pass through\n  const pdfBytes = fs.readFileSync(item.tempFiles[0]);\n  return [{\n    json: { ...item, skipMerge: true },\n    binary: {\n      data: {\n        data: pdfBytes.toString('base64'),\n        mimeType: 'application/pdf',\n        fileName: `spell-cards-${item.className}-filled.pdf`\n      }\n    }\n  }];\n}\n\n// Multiple files â€” output one item per temp PDF for merge\nreturn item.tempFiles.map((filePath, i) => {\n  const pdfBytes = fs.readFileSync(filePath);\n  return {\n    json: { ...item, fileIndex: i, skipMerge: false },\n    binary: {\n      data: {\n        data: pdfBytes.toString('base64'),\n        mimeType: 'application/pdf',\n        fileName: `page_${i}.pdf`\n      }\n    }\n  };\n});"},"id":"648bc11d-5d5a-4a25-9298-8bf3441523cb","name":"ğŸ“‚ Load Batch PDFs","type":"n8n-nodes-base.code","typeVersion":2,"position":[2272,640],"notes":"Reads all temp PDFs for a class from disk.\n\nSingle-page classes: outputs 1 item (skips merge).\nMulti-page classes: outputs N items with binary for merge."},{"parameters":{"operation":"writeFile"},"id":"9896360e-6106-4535-9c48-4a5fb5b61f61","name":"ğŸ’¾ Save Final PDF","type":"n8n-nodes-base.readWriteFile","typeVersion":1,"position":[2704,640],"notes":"Saves the merged PDF to the output directory"},{"parameters":{"jsCode":"const fs = require('fs');\nconst cfg = $('âš™ï¸ Configuration').first().json;\nconst files = fs.readdirSync(cfg.outputDir).filter(f => f.endsWith('.pdf')).sort();\n\nconsole.log('\\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nconsole.log('  SPELL CARDS COMPLETE');\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\nfor (const f of files) {\n  const stats = fs.statSync(`${cfg.outputDir}/${f}`);\n  console.log(`  âœ… ${f} (${Math.round(stats.size/1024)}KB)`);\n}\nconsole.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n');\n\nreturn [{ json: { status: 'complete', files, count: files.length } }];"},"id":"b85529a2-da50-418a-8be3-954556cc91b4","name":"ğŸ“Š Summary","type":"n8n-nodes-base.code","typeVersion":2,"position":[2352,912]},{"parameters":{"content":"## D&D Spell Card Generator\n### Uses actual PDF templates via Fill Form + Merge\n\nNo Python â€¢ No npm install â€¢ TrueNAS compatible\n\n**Phase 1 â€” Fill:** Loop fills each template page (8 cards max)\n**Phase 2 â€” Merge:** Groups by class, merges multi-page classes\n\n**Requires:**\n- @custom-js/n8n-nodes-pdf-toolkit\n- CustomJS API credential\n- Anthropic API credential\n- Template PDFs in /data/spell-templates/","height":320,"width":448},"id":"a54075b3-4a12-4964-86a8-d21fb6b99c14","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-848,32]},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":3.1,"position":[928,288],"id":"c7a9dc2d-0805-47c3-afff-8d026f5cdd09","name":"AI Agent"},{"parameters":{"model":{"__rl":true,"value":"claude-opus-4-6","mode":"list","cachedResultName":"Claude Opus 4.6"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatAnthropic","typeVersion":1.3,"position":[928,496],"id":"0fb0a122-03d1-4767-b293-1e3f7e330efa","name":"Anthropic Chat Model","credentials":{"anthropicApi":{"id":"uch0Rcb3BF9tligH","name":"Anthropic account"}}},{"parameters":{},"type":"@custom-js/n8n-nodes-pdf-toolkit.PdfToText","typeVersion":1,"position":[416,272],"id":"db3c20d6-febc-4839-9648-4f68dcef3a46","name":"PdfToText binary","credentials":{"customJsApi":{"id":"70mIKD9bN6EBtnTS","name":"CustomJS account"}}}],"connections":{"Start":{"main":[[{"node":"âš™ï¸ Configuration","type":"main","index":0}]]},"Normalize Text":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"ğŸ“‹ Parse All Batches":{"main":[[{"node":"ğŸ”„ Fill Loop","type":"main","index":0}]]},"ğŸ”„ Fill Loop":{"main":[[{"node":"ğŸ“– Read Template","type":"main","index":0}],[{"node":"ğŸ“‹ Group By Class","type":"main","index":0}]]},"ğŸ“– Read Template":{"main":[[{"node":"ğŸ’¾ Save Temp Page","type":"main","index":0}]]},"ğŸ’¾ Save Temp Page":{"main":[[{"node":"ğŸ”„ Fill Loop","type":"main","index":0}]]},"ğŸ“‹ Group By Class":{"main":[[{"node":"ğŸ”„ Merge Loop","type":"main","index":0}]]},"ğŸ”„ Merge Loop":{"main":[[{"node":"ğŸ“‚ Load Batch PDFs","type":"main","index":0}],[{"node":"ğŸ“Š Summary","type":"main","index":0}]]},"ğŸ“‚ Load Batch PDFs":{"main":[[{"node":"ğŸ’¾ Save Final PDF","type":"main","index":0}]]},"ğŸ’¾ Save Final PDF":{"main":[[{"node":"ğŸ”„ Merge Loop","type":"main","index":0}]]},"AI Agent":{"main":[[{"node":"ğŸ“‹ Parse All Batches","type":"main","index":0}]]},"Anthropic Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"âš™ï¸ Configuration":{"main":[[{"node":"PdfToText binary","type":"main","index":0}]]},"PdfToText binary":{"main":[[{"node":"Normalize Text","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","binaryMode":"separate","availableInMCP":false},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"17580906-4a37-4339-80c9-22c714b6b217","activeVersionId":null,"versionCounter":36,"triggerCount":0,"shared":[{"updatedAt":"2026-02-15T23:18:53.716Z","createdAt":"2026-02-15T23:18:53.716Z","role":"workflow:owner","workflowId":"uEwgCctMfRURMOie","projectId":"IbSEWMWujt4v9pwR","project":{"updatedAt":"2026-01-20T02:36:13.950Z","createdAt":"2025-12-27T17:56:55.369Z","id":"IbSEWMWujt4v9pwR","name":"Zac Clifton <zac16530@gmail.com>","type":"personal","icon":null,"description":null,"creatorId":"ec0e00c1-c94c-415c-8a06-1d74c6c63f94"}}],"tags":[],"activeVersion":null}