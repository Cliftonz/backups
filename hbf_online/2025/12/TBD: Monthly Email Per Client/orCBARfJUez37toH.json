{"updatedAt":"2025-12-20T00:21:19.463Z","createdAt":"2025-12-20T00:08:42.696Z","id":"orCBARfJUez37toH","name":"TBD: Monthly Email Per Client","description":null,"active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"months","triggerAtHour":9}]}},"id":"87b76cc5-260c-4a77-92ba-0dacfb9effa3","name":"Monthly Schedule","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.3,"position":[-5120,-304]},{"parameters":{"assignments":{"assignments":[{"id":"id-1","name":"dryRunMode","value":false,"type":"boolean"},{"id":"id-2","name":"reportMonth","value":"={{ $now.minus({ months: 1 }).toFormat('MMMM yyyy') }}","type":"string"},{"id":"id-3","name":"reportMonthStart","value":"={{ $now.minus({ months: 1 }).startOf('month').toISO() }}","type":"string"},{"id":"id-4","name":"reportMonthEnd","value":"={{ $now.minus({ months: 1 }).endOf('month').toISO() }}","type":"string"},{"id":"id-5","name":"lookbackDays","value":90,"type":"number"}]},"includeOtherFields":true,"options":{}},"id":"93b71962-9a79-417c-b384-b45f4f199ab4","name":"Workflow Configuration","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-4896,-304]},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"id-1","leftValue":"={{ $json.email }}","operator":{"type":"string","operation":"notEmpty"}},{"id":"id-2","leftValue":"={{ $json.name }}","operator":{"type":"string","operation":"notEmpty"}}],"combinator":"and"},"options":{}},"id":"f914b385-cb35-4ce8-aa5a-8a29ab045526","name":"Filter Valid Clients","type":"n8n-nodes-base.filter","typeVersion":2.3,"position":[-4448,-304]},{"parameters":{"jsCode":"// Access transactions from input 0 (QBO Transactions) and account balances from input 1 (QBO Account Balances)\nconst qboTransactionsInput = $input.all(0);\nconst qboAccountBalancesInput = $input.first(1);\n\n// Get client information from Filter Valid Clients node\nconst clientData = $('Filter Valid Clients').first().json;\nconst clientId = clientData.id || clientData.client_id;\nconst clientName = clientData.name;\nconst clientEmail = clientData.email;\n\n// Parse QuickBooks transactions\nconst transactions = [];\nlet revenue = 0;\nlet expenses = 0;\n\nfor (const item of qboTransactionsInput) {\n  const txn = item.json;\n  \n  // Extract transaction details from QuickBooks structure\n  const txnDate = txn.TxnDate || txn.MetaData?.CreateTime;\n  const txnId = txn.Id;\n  \n  // Process Line items for amounts and account references\n  if (txn.Line && Array.isArray(txn.Line)) {\n    for (const line of txn.Line) {\n      const amount = parseFloat(line.Amount) || 0;\n      const accountRef = line.AccountRef;\n      const accountType = line.AccountRef?.type || accountRef?.AccountType;\n      \n      // Extract vendor information from EntityRef\n      const vendor = txn.EntityRef?.name || line.EntityRef?.name || 'Unknown';\n      \n      // Extract category from AccountRef\n      const category = accountRef?.name || 'Uncategorized';\n      \n      // Store transaction details\n      const transactionRecord = {\n        id: txnId,\n        date: txnDate,\n        amount: amount,\n        vendor: vendor,\n        category: category,\n        account_type: accountType,\n        updated_at: txn.MetaData?.LastUpdatedTime\n      };\n      \n      transactions.push(transactionRecord);\n      \n      // Calculate revenue from income account types\n      if (accountType && accountType.toLowerCase().includes('income')) {\n        revenue += Math.abs(amount);\n      }\n      \n      // Calculate expenses from expense account types\n      if (accountType && accountType.toLowerCase().includes('expense')) {\n        expenses += Math.abs(amount);\n      }\n    }\n  }\n}\n\n// Calculate net profit\nconst netProfit = revenue - expenses;\n\n// Extract cash balance from bank account CurrentBalance field\nlet endingCash = 0;\nif (qboAccountBalancesInput && qboAccountBalancesInput.json) {\n  const accountData = qboAccountBalancesInput.json;\n  \n  // Check for CurrentBalance field\n  if (accountData.CurrentBalance) {\n    endingCash = parseFloat(accountData.CurrentBalance);\n  } else if (accountData.Balance) {\n    endingCash = parseFloat(accountData.Balance);\n  }\n  \n  // If account balances is an array, find bank accounts\n  if (Array.isArray(accountData)) {\n    for (const account of accountData) {\n      if (account.AccountType === 'Bank' && account.CurrentBalance) {\n        endingCash += parseFloat(account.CurrentBalance);\n      }\n    }\n  }\n}\n\n// Return a single item with all calculated data\nreturn [\n  {\n    json: {\n      clientId: clientId,\n      clientName: clientName,\n      clientEmail: clientEmail,\n      revenue: revenue,\n      expenses: expenses,\n      netProfit: netProfit,\n      endingCash: endingCash,\n      transactions: transactions\n    }\n  }\n];"},"id":"5c5bab4b-3be3-4bc5-887e-8ac42d580696","name":"Calculate Financial Summary","type":"n8n-nodes-base.code","typeVersion":2,"position":[-4000,-400]},{"parameters":{"jsCode":"// Access financial summary from input 0 and historical transactions from input 1\nconst financialSummary = $input.first(0);\nconst historicalTransactionsData = $input.all(1);\n\n// Get configuration data\nconst config = $('Workflow Configuration').first().json;\nconst reportMonthStart = new Date(config.reportMonthStart);\nconst reportMonthEnd = new Date(config.reportMonthEnd);\n\n// Build historical vendor set from input 1 transactions\n// Extract vendor names from QuickBooks EntityRef field\nconst historicalVendors = new Set();\nfor (const item of historicalTransactionsData) {\n  const transaction = item.json;\n  // QuickBooks uses EntityRef for vendor information\n  if (transaction.EntityRef && transaction.EntityRef.name) {\n    historicalVendors.add(transaction.EntityRef.name);\n  }\n}\n\n// Initialize array for notable expenses\nconst notableExpenses = [];\n\n// Iterate through transactions to identify notable expenses\nif (financialSummary.json.transactions && Array.isArray(financialSummary.json.transactions)) {\n  for (const transaction of financialSummary.json.transactions) {\n    // Extract vendor name from QuickBooks EntityRef field\n    const vendor = transaction.EntityRef?.name;\n    const amount = transaction.Amount || transaction.amount;\n    const category = transaction.AccountRef?.name || transaction.category;\n    \n    // Check MetaData.LastUpdatedTime for newly categorized expenses\n    const lastUpdatedTime = transaction.MetaData?.LastUpdatedTime ? new Date(transaction.MetaData.LastUpdatedTime) : null;\n    \n    // Skip if no vendor\n    if (!vendor) continue;\n    \n    // Check if this is a new vendor (not in historical set)\n    const isNewVendor = !historicalVendors.has(vendor);\n    \n    // Check if this is a newly categorized expense\n    // (LastUpdatedTime is within the report month and category is not null/uncategorized)\n    const isNewlyCategorized = lastUpdatedTime && \n      lastUpdatedTime >= reportMonthStart && \n      lastUpdatedTime <= reportMonthEnd && \n      category && \n      category.toLowerCase() !== 'uncategorized';\n    \n    // Add to notable expenses if it meets criteria\n    if (isNewVendor || isNewlyCategorized) {\n      let expenseType;\n      \n      if (isNewVendor && isNewlyCategorized) {\n        expenseType = 'new_vendor';\n      } else if (isNewVendor) {\n        expenseType = 'new_vendor';\n      } else if (isNewlyCategorized) {\n        expenseType = 'newly_categorized';\n      }\n      \n      notableExpenses.push({\n        vendor: vendor,\n        amount: amount,\n        category: category || 'Uncategorized',\n        type: expenseType,\n        date: transaction.TxnDate || transaction.date\n      });\n    }\n  }\n}\n\n// Return the financial summary with added notableExpenses array\nreturn [{\n  json: {\n    ...financialSummary.json,\n    notableExpenses: notableExpenses\n  }\n}];"},"id":"5022c0ba-80d6-4c0b-b1a8-12d3c1a5243a","name":"Detect New and Categorized Expenses","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3776,-304]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Extract report month from Workflow Configuration\nconst reportMonth = $('Workflow Configuration').first().json.reportMonth;\n\n// Helper function to format currency\nfunction formatCurrency(amount) {\n  if (amount === null || amount === undefined) return '$0.00';\n  const num = parseFloat(amount);\n  return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });\n}\n\n// Extract financial data from current item\nconst clientEmail = $json.clientEmail;\nconst clientName = $json.clientName;\nconst revenue = $json.revenue || 0;\nconst totalExpenses = $json.totalExpenses || 0;\nconst netProfit = $json.netProfit || 0;\nconst endingCashBalance = $json.endingCashBalance || 0;\nconst notableExpenses = $json.notableExpenses || [];\nconst newVendors = $json.newVendors || [];\nconst categorizedExpenses = $json.categorizedExpenses || [];\n\n// Build email subject\nconst emailSubject = `${reportMonth} Bookkeeping Summary & New Expense Activity`;\n\n// Build Notable Activity paragraph\nlet notableActivityText = '';\nif (notableExpenses.length > 0 || newVendors.length > 0) {\n  const parts = [];\n  if (newVendors.length > 0) {\n    parts.push(`${newVendors.length} new vendor${newVendors.length > 1 ? 's' : ''} appeared`);\n  }\n  if (notableExpenses.length > 0) {\n    parts.push(`${notableExpenses.length} notable expense${notableExpenses.length > 1 ? 's' : ''} recorded`);\n  }\n  notableActivityText = `This month, ${parts.join(' and ')}.`;\n} else {\n  notableActivityText = 'No unusual activity detected this month.';\n}\n\n// Build Items to Be Aware Of section\nlet itemsToBeAwareOfHTML = '';\nif (notableExpenses.length > 0) {\n  itemsToBeAwareOfHTML = '<h3 style=\"color: #333; margin-top: 30px;\">Items to Be Aware Of</h3><ul style=\"line-height: 1.8;\">';\n  notableExpenses.forEach(expense => {\n    const vendor = expense.vendor || 'Unknown Vendor';\n    const amount = formatCurrency(expense.amount);\n    const category = expense.category || 'Uncategorized';\n    const type = expense.type || 'expense';\n    itemsToBeAwareOfHTML += `<li><strong>${vendor}</strong> — ${amount} → ${category} (${type})</li>`;\n  });\n  itemsToBeAwareOfHTML += '</ul>';\n}\n\n// Build HTML email body\nconst emailBody = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }\n    h3 { color: #333; margin-top: 25px; }\n    table { width: 100%; border-collapse: collapse; margin: 20px 0; }\n    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }\n    th { background-color: #3498db; color: white; }\n    tr:hover { background-color: #f5f5f5; }\n    .amount { text-align: right; font-weight: bold; }\n    .positive { color: #27ae60; }\n    .negative { color: #e74c3c; }\n    p { margin: 15px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <h2>${reportMonth} Bookkeeping Summary</h2>\n    \n    <h3>Monthly Financial Snapshot</h3>\n    <table>\n      <tr>\n        <th>Metric</th>\n        <th class=\"amount\">Amount</th>\n      </tr>\n      <tr>\n        <td>Revenue</td>\n        <td class=\"amount positive\">${formatCurrency(revenue)}</td>\n      </tr>\n      <tr>\n        <td>Total Expenses</td>\n        <td class=\"amount negative\">${formatCurrency(totalExpenses)}</td>\n      </tr>\n      <tr>\n        <td>Net Profit</td>\n        <td class=\"amount ${netProfit >= 0 ? 'positive' : 'negative'}\">${formatCurrency(netProfit)}</td>\n      </tr>\n      <tr>\n        <td>Ending Cash Balance</td>\n        <td class=\"amount\">${formatCurrency(endingCashBalance)}</td>\n      </tr>\n    </table>\n    \n    <h3>Notable Activity This Month</h3>\n    <p>${notableActivityText}</p>\n    \n    ${itemsToBeAwareOfHTML}\n    \n    <p style=\"margin-top: 30px; color: #7f8c8d; font-size: 0.9em;\">\n      This is an automated monthly summary. If you have any questions, please reply to this email.\n    </p>\n  </div>\n</body>\n</html>\n`;\n\n// Return output with all fields preserved\nreturn {\n  ...($json),\n  clientEmail,\n  emailSubject,\n  emailBody\n};"},"id":"b0c003f2-35ff-4afc-82b0-99676c1ce3b3","name":"Generate Email HTML","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3552,-304]},{"parameters":{"conditions":{"options":{"caseSensitive":false,"leftValue":"","typeValidation":"loose"},"conditions":[{"id":"id-1","leftValue":"={{ $('Workflow Configuration').first().json.dryRunMode }}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"5f0e6fe9-589f-4008-bf2e-a89b5e458614","name":"Check Dry Run Mode","type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-3328,-304]},{"parameters":{"sendTo":"={{ $json.clientEmail }}","subject":"={{ $json.emailSubject }}","message":"={{ $json.emailBody }}","options":{}},"id":"7eaaece0-9211-4759-984e-31621a696d22","name":"Send Email via Gmail","type":"n8n-nodes-base.gmail","typeVersion":2.2,"position":[-3104,-400],"webhookId":"72f56d2f-493c-47f9-978b-b5d6849a54a6","credentials":{"gmailOAuth2":{"id":"OK1hFEYTVwQ7tSoT","name":"Gmail account"}}},{"parameters":{"assignments":{"assignments":[{"id":"id-1","name":"dryRunLog","value":"Email draft generated but not sent (dry run mode enabled)","type":"string"},{"id":"id-2","name":"timestamp","value":"={{ $now.toISO() }}","type":"string"}]},"includeOtherFields":true,"options":{}},"id":"71118053-427e-42d4-b919-b75f283b8f0f","name":"Log Dry Run Output","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3104,-208]},{"parameters":{"assignments":{"assignments":[{"id":"id-1","name":"name","value":"<__PLACEHOLDER_VALUE__Client Name__>","type":"string"},{"id":"id-2","name":"email","value":"<__PLACEHOLDER_VALUE__Client Email Address__>","type":"string"},{"id":"id-3","name":"qboCompanyId","value":"<__PLACEHOLDER_VALUE__QuickBooks Company ID__>","type":"string"}]},"includeOtherFields":true,"options":{}},"id":"b31a99a9-2f1e-489a-aef7-e466ecdc6355","name":"Define Client List","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-4672,-304]},{"parameters":{"resource":"transaction","filters":{"dateRangeCustom":{"dateRangeCustomProperties":{"start_date":"={{ $('Workflow Configuration').first().json.reportMonthStart }}","end_date":"={{ $('Workflow Configuration').first().json.reportMonthEnd }}"}}}},"id":"e5c25965-22c6-493c-9026-bea87a1a2f33","name":"Get QBO Transactions","type":"n8n-nodes-base.quickbooks","typeVersion":1,"position":[-4224,-496]},{"parameters":{"resource":"__CUSTOM_API_CALL__"},"id":"1f051a5c-2ebd-466e-bc58-7556530587b7","name":"Get QBO Account Balances","type":"n8n-nodes-base.quickbooks","typeVersion":1,"position":[-4224,-304]},{"parameters":{"resource":"transaction","filters":{"date_macro":"This Month"}},"id":"a016b27d-ab05-42bd-8030-9fb9b4a6872f","name":"Get QBO Historical Transactions","type":"n8n-nodes-base.quickbooks","typeVersion":1,"position":[-4000,-136]}],"connections":{"Monthly Schedule":{"main":[[{"node":"Workflow Configuration","type":"main","index":0}]]},"Workflow Configuration":{"main":[[{"node":"Define Client List","type":"main","index":0}]]},"Filter Valid Clients":{"main":[[{"node":"Get QBO Transactions","type":"main","index":0},{"node":"Get QBO Account Balances","type":"main","index":0},{"node":"Get QBO Historical Transactions","type":"main","index":0}]]},"Calculate Financial Summary":{"main":[[{"node":"Detect New and Categorized Expenses","type":"main","index":0}]]},"Detect New and Categorized Expenses":{"main":[[{"node":"Generate Email HTML","type":"main","index":0}]]},"Generate Email HTML":{"main":[[{"node":"Check Dry Run Mode","type":"main","index":0}]]},"Check Dry Run Mode":{"main":[[{"node":"Send Email via Gmail","type":"main","index":0}],[{"node":"Log Dry Run Output","type":"main","index":0}]]},"Define Client List":{"main":[[{"node":"Filter Valid Clients","type":"main","index":0}]]},"Get QBO Transactions":{"main":[[{"node":"Calculate Financial Summary","type":"main","index":0}]]},"Get QBO Account Balances":{"main":[[{"node":"Calculate Financial Summary","type":"main","index":0}]]},"Get QBO Historical Transactions":{"main":[[{"node":"Detect New and Categorized Expenses","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"a9e3b5a3-880d-42f2-a3c7-52b8f1359c20","activeVersionId":null,"versionCounter":4,"triggerCount":0,"shared":[{"updatedAt":"2025-12-20T00:08:42.698Z","createdAt":"2025-12-20T00:08:42.698Z","role":"workflow:owner","workflowId":"orCBARfJUez37toH","projectId":"pPfvO125ydUVIXPh","project":{"updatedAt":"2025-12-08T14:51:48.381Z","createdAt":"2025-12-08T14:51:42.916Z","id":"pPfvO125ydUVIXPh","name":"Alex   <alex@honeybearfinancials.com>","type":"personal","icon":null,"description":null,"creatorId":"b5c2bbf4-eb13-4025-80fb-2acb074cc668","projectRelations":[{"updatedAt":"2025-12-08T14:51:42.916Z","createdAt":"2025-12-08T14:51:42.916Z","userId":"b5c2bbf4-eb13-4025-80fb-2acb074cc668","projectId":"pPfvO125ydUVIXPh","user":{"updatedAt":"2026-02-07T05:33:06.000Z","createdAt":"2025-12-08T14:51:40.983Z","id":"b5c2bbf4-eb13-4025-80fb-2acb074cc668","email":"alex@honeybearfinancials.com","firstName":"Alex","lastName":" ","personalizationAnswers":null,"settings":{"userActivated":true,"userClaimedAiCredits":true,"easyAIWorkflowOnboarded":true,"firstSuccessfulWorkflowId":"AqqHC4HlzK2Gq3eR","userActivatedAt":1766876864154,"npsSurvey":{"responded":true,"lastShownAt":1768748391500}},"disabled":false,"mfaEnabled":false,"lastActiveAt":"2026-02-07","isPending":false}}]}}],"tags":[],"activeVersion":null}